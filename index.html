<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ASIAX TEAM - SafePal DApp</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- Ethers.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg,#0a0e1a,#1a1f2e,#0a0e1a);
      color:#e8f0ff;
      font-family:'Inter',sans-serif;
      padding:16px;
    }
    .app {max-width:420px;margin:0 auto;}
    .topbar {
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:16px;padding:10px 16px;margin-bottom:16px;
    }
    .btn-modern {
      background:linear-gradient(135deg,#00d4ff,#00ff88);
      color:#000;font-weight:600;border:none;
      border-radius:14px;padding:10px 16px;
    }
    .card-app {
      background:rgba(255,255,255,0.05);
      border-radius:16px;border:1px solid rgba(255,255,255,0.1);
      padding:16px;margin-bottom:16px;
      box-shadow:0 6px 20px rgba(0,0,0,0.3);
    }
    .status {text-align:center;font-size:0.9rem;margin-bottom:12px;}
    .success {color:#00ff88;}
    .error {color:#ff4757;}
    .member {
      background:rgba(255,255,255,0.05);
      border:1px solid #00ff88;border-radius:12px;
      padding:12px;margin-bottom:10px;
    }
    .copy {cursor:pointer;color:#00ff88;}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <img src="prologo.png" alt="ASIAX" style="height:40px;">
    <button id="connectBtn" class="btn-modern"><i class="fas fa-wallet"></i> <span id="connectLabel">Connect</span></button>
  </div>

  <div id="status" class="status">Ready — SafePal DApp</div>

  <div class="card-app">
    <div><b>Your Address:</b> <span id="userAddress">Not Connected</span></div>
  </div>

  <div class="card-app">
    <div style="text-align:center;font-weight:700;color:#00d4ff;margin-bottom:8px;">My Direct Team</div>
    <button id="loadTeam" class="btn-modern w-100" disabled>Load Team</button>
    <div id="loader" style="text-align:center;display:none;margin-top:10px;">
      <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>
    <div id="teamContainer" style="margin-top:10px;display:none;"></div>
  </div>
</div>

<script>
  const CONTRACT_ADDR = "0xF6d0d72AAf0Bbf5C459E680f1e6E75E3B1ce1f06"; // <--- change later
  const RPC_URL = "https://polygon-rpc.com";
  const POLYGON_CHAIN_ID = "0x89";
  const HOME_PAGE = "axmenu.html";

  let provider, walletAddress;

  // 🔹 Auto Detect SafePal Provider
  function detectProvider() {
    if (window.ethereum && window.ethereum.isSafePal) return window.ethereum;
    if (window.safepal && window.safepal.ethereum) return window.safepal.ethereum;
    if (window.ethereum) return window.ethereum;
    return null;
  }

  async function connectWallet() {
    const safeProvider = detectProvider();
    if (!safeProvider) {
      alert("⚠️ Open this page in SafePal Wallet DApp Browser!");
      return;
    }
    try {
      const chain = await safeProvider.request({method:"eth_chainId"});
      if (chain !== POLYGON_CHAIN_ID) {
        await safeProvider.request({
          method:"wallet_switchEthereumChain",
          params:[{chainId:POLYGON_CHAIN_ID}]
        });
      }
      const accounts = await safeProvider.request({method:"eth_requestAccounts"});
      walletAddress = accounts[0];
      provider = new ethers.providers.JsonRpcProvider(RPC_URL); // read-only Polygon RPC

      updateUI();
      showStatus("✅ Connected", "success");
    } catch(e) {
      showStatus("❌ Connection Failed: " + e.message, "error");
    }
  }function updateUI() {
    document.getElementById("userAddress").innerText =
      walletAddress.substring(0,6) + "..." + walletAddress.slice(-4);
    document.getElementById("connectLabel").innerText = "Connected";
    document.getElementById("connectBtn").disabled = true;
    document.getElementById("loadTeam").disabled = false;
  }

  function showStatus(msg,type="") {
    const el = document.getElementById("status");
    el.innerText = msg;
    el.className = "status " + type;
  }

  // 🔹 Load Direct Team (universal method)
  document.getElementById("loadTeam").onclick = async () => {
    showStatus("⏳ Loading team...");
    document.getElementById("loader").style.display="block";
    document.getElementById("teamContainer").style.display="none";

    try {
      const abi = [
        "event UserJoined(address indexed user, address indexed referrer, uint256 amount, uint256 netInvestment)"
      ];
      const rpcProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
      const contract = new ethers.Contract(CONTRACT_ADDR, abi, rpcProvider);

      const filter = contract.filters.UserJoined();
      const events = await contract.queryFilter(filter);

      const team = events
        .filter(e => e.args.referrer.toLowerCase() === walletAddress.toLowerCase())
        .map(e => e.args.user);

      renderTeam(team);
      document.getElementById("loader").style.display="none";
      document.getElementById("teamContainer").style.display="block";
      showStatus("✅ Loaded " + team.length + " Members","success");
    } catch(e) {
      document.getElementById("loader").style.display="none";
      showStatus("❌ Error loading team: " + e.message, "error");
    }
  };

  function renderTeam(list) {
    const container = document.getElementById("teamContainer");
    container.innerHTML = "";
    list.forEach(addr => {
      const div = document.createElement("div");
      div.className = "member";
      div.innerHTML = 
        <div><b>${addr.substring(0,6)}...${addr.slice(-4)}</b> 
        <i class="fas fa-copy copy" title="Copy"></i></div>
      ;
      div.querySelector(".copy").onclick = () => {
        navigator.clipboard.writeText(addr);
        showStatus("✅ Address Copied!","success");
      };
      container.appendChild(div);
    });
  }

  // 🔹 Auto connect if already authorized
  window.addEventListener("load", async () => {
    const safeProvider = detectProvider();
    if (safeProvider) {
      try {
        const acc = await safeProvider.request({method:"eth_accounts"});
        if (acc.length > 0) {
          walletAddress = acc[0];
          provider = new ethers.providers.JsonRpcProvider(RPC_URL);
          updateUI();
          showStatus("🔗 Auto Connected","success");
        }
      } catch {}
    }
  });

  document.getElementById("connectBtn").onclick = connectWallet;
</script>
</body>
</html>

